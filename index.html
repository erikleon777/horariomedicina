// ===== FUNCI√ìN MEJORADA PARA EXPORTAR A EXCEL CON MEJOR FORMATO =====
window.exportarAExcel = function() {
    const tabla = document.getElementById('horario');
    
    if (!tabla || tabla.innerHTML.trim() === '') {
        alert('No hay horario generado para exportar.');
        return;
    }
    
    try {
        // Clonar la tabla para no modificar la original
        const tablaClone = tabla.cloneNode(true);
        
        // Preservar los colores de fondo y estilos
        const filas = tablaClone.querySelectorAll('tr');
        filas.forEach(fila => {
            const celdas = fila.querySelectorAll('td');
            celdas.forEach(celda => {
                // Buscar la celda original para copiar estilos
                const originalCelda = Array.from(document.querySelectorAll('#horario td')).find(
                    td => td.textContent === celda.textContent && 
                          td.parentElement.rowIndex === fila.rowIndex
                );
                
                if (originalCelda) {
                    const bgColor = window.getComputedStyle(originalCelda).backgroundColor;
                    if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
                        celda.style.backgroundColor = bgColor;
                    }
                    
                    // Copiar color de texto si es especial (como los cruces en rojo)
                    const color = window.getComputedStyle(originalCelda).color;
                    if (color && color !== 'rgb(0, 0, 0)') {
                        celda.style.color = color;
                    }
                }
            });
        });
        
        // Obtener informaci√≥n de las materias seleccionadas
        const materiasInfo = [];
        document.querySelectorAll('#contenedor-materias .columna-materia').forEach(columna => {
            const nombreMateria = columna.querySelector('h2')?.textContent || '';
            const gruposSeleccionados = [];
            
            columna.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                if (cb.id.includes('subgrupo-')) {
                    gruposSeleccionados.push(cb.value);
                }
            });
            
            if (gruposSeleccionados.length > 0) {
                materiasInfo.push(`${nombreMateria} (Grupos: ${gruposSeleccionados.join(', ')})`);
            }
        });
        
        // Crear contenido con mejor formato
        const fecha = new Date().toLocaleString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const contenidoHTML = `
            <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Horario de Medicina - U.A.G.R.M.</title>
                    <style>
                        body { 
                            font-family: 'Calibri', 'Segoe UI', Arial, sans-serif; 
                            margin: 20px; 
                            background-color: #ffffff;
                        }
                        .header { 
                            background: linear-gradient(135deg, #0f172a, #1e293b);
                            color: white; 
                            padding: 20px; 
                            border-radius: 10px 10px 0 0;
                            margin-bottom: 0;
                        }
                        h1 { 
                            margin: 0; 
                            font-size: 24px; 
                            font-weight: 500;
                        }
                        .subheader {
                            background: #f8fafc;
                            padding: 15px 20px;
                            border: 1px solid #e2e8f0;
                            border-top: none;
                            margin-bottom: 20px;
                        }
                        .info-grid {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 20px;
                            margin-bottom: 10px;
                        }
                        .info-item {
                            flex: 1;
                            min-width: 200px;
                        }
                        .info-label {
                            font-weight: bold;
                            color: #2563eb;
                            font-size: 12px;
                            text-transform: uppercase;
                            margin-bottom: 4px;
                        }
                        .info-value {
                            font-size: 14px;
                            color: #0f172a;
                        }
                        table { 
                            border-collapse: collapse; 
                            width: 100%; 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            background: white;
                        }
                        th { 
                            background: #2563eb; 
                            color: white; 
                            padding: 12px 8px; 
                            text-align: center; 
                            border: 1px solid #1e40af;
                            font-weight: 600;
                            font-size: 12px;
                            text-transform: uppercase;
                        }
                        td { 
                            border: 1px solid #cbd5e1; 
                            padding: 10px 6px; 
                            vertical-align: top;
                            font-size: 11px;
                        }
                        .materia-nombre {
                            font-weight: bold;
                            color: #0f172a;
                            display: block;
                            margin-bottom: 3px;
                        }
                        .grupo-info {
                            color: #475569;
                            font-size: 10px;
                        }
                        .docente-info {
                            color: #64748b;
                            font-size: 10px;
                            font-style: italic;
                        }
                        .cruce {
                            background-color: #fee2e2 !important;
                            color: #991b1b !important;
                            font-weight: bold;
                        }
                        .footer { 
                            margin-top: 30px; 
                            color: #64748b; 
                            font-size: 10px; 
                            text-align: center;
                            border-top: 2px solid #e2e8f0;
                            padding-top: 15px;
                        }
                        .materias-list {
                            background: #f1f5f9;
                            padding: 10px 15px;
                            border-radius: 8px;
                            font-size: 11px;
                        }
                        .materias-list ul {
                            margin: 5px 0;
                            padding-left: 20px;
                        }
                        .materias-list li {
                            color: #334155;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üè• Facultad de Medicina - U.A.G.R.M.</h1>
                    </div>
                    
                    <div class="subheader">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">üìÖ Fecha de generaci√≥n</div>
                                <div class="info-value">${fecha}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">üìö Materias inscritas</div>
                                <div class="info-value">${materiasInfo.length}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">üë®‚Äç‚öïÔ∏è Per√≠odo acad√©mico</div>
                                <div class="info-value">Primer Semestre 2026</div>
                            </div>
                        </div>
                        
                        ${materiasInfo.length > 0 ? `
                        <div class="materias-list">
                            <strong>üìñ Materias seleccionadas:</strong>
                            <ul>
                                ${materiasInfo.map(m => `<li>${m}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${tablaClone.outerHTML}
                    
                    <div class="footer">
                        <p>Horario generado con la Plataforma de Horarios - Medicina U.A.G.R.M. (No oficial)</p>
                        <p>Desarrollado por Erik Le√≥n - 2026 | Los horarios est√°n sujetos a cambios seg√∫n disposici√≥n de la facultad</p>
                        <p style="font-size: 9px; margin-top: 10px;">* Los colores representan diferentes grupos y materias para mejor visualizaci√≥n</p>
                    </div>
                </body>
            </html>
        `;
        
        // Descargar archivo con nombre m√°s descriptivo
        const fechaArchivo = new Date().toISOString().split('T')[0];
        const horaArchivo = new Date().toLocaleTimeString('es-ES').replace(/:/g, '-');
        const nombreArchivo = `Horario_Medicina_${fechaArchivo}_${horaArchivo}.xls`;
        
        const blob = new Blob([contenidoHTML], { type: 'application/vnd.ms-excel' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = nombreArchivo;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Feedback visual mejorado
        const btn = event?.target;
        if (btn) {
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = '‚úÖ ¬°Exportado con √©xito!';
            btn.style.background = 'linear-gradient(135deg, #059669, #047857)';
            btn.style.transform = 'scale(0.98)';
            setTimeout(() => {
                btn.innerHTML = textoOriginal;
                btn.style.transform = 'scale(1)';
            }, 2000);
        }
        
    } catch (error) {
        console.error('Error detallado:', error);
        alert('Hubo un error al exportar. Por favor, intente nuevamente.');
    }
};
